# frozen_string_literal: true

require 'spec_helper'

describe SolarPhotovoltaics::BenefitEstimatorService, type: :service do
  let(:service) { SolarPhotovoltaics::BenefitEstimatorService.new(school: @acme_academy, asof_date: Date.parse('2020-12-31')) }

  # using before(:all) here to avoid slow loading of YAML and then
  # running the aggregation code for each test.
  before(:all) do
    @acme_academy = load_unvalidated_meter_collection(school: 'acme-academy')
  end

  context '' do
    it '' do
      service.calculate_benefits!
      puts service.solar_pv_scenario_table.inspect
      expect(service.solar_pv_scenario_table).to eq(
        [
          [1, 3, 4, 893.9545973935678, 0.0, 893.954597393567, 0.002068165948887468, 140.1736542641811, 169.22840876311736, 2392.9653, 17.07143409053209],
          [2, 7, 10, 1787.9091947871332, 0.0, 1787.909194787134, 0.004136331897774667, 280.34730852871144, 338.4568175262347, 3184.1412, 11.357844727351466],
          [4, 13, 19, 3575.8183895742663, 0.0, 3575.818389574268, 0.008272663795547853, 560.6946170564115, 676.9136350524694, 4761.1248, 8.491475850072202],
          [8, 27, 39, 7151.636779148539, 0.0, 7151.636779148536, 0.016545327591100552, 1121.3892341130122, 1353.8272701049389, 7893.6192, 7.0391430199913],
          [16, 53, 76, 14_303.273558297074, 0.0, 14_303.273558297073, 0.03309065518220407, 2242.778468225384, 2707.6545402098777, 14_072.7168, 6.274679822093685],
          [32, 107, 154, 28_554.856062377454, 51.691054216699065, 28_606.547116594145, 0.06606172299553545, 4479.975043753114, 5415.309080419755, 26_087.3472, 5.823101009541616],
          [52.5, 175, 252, 45_293.93854982251, 1638.67781333994, 46_932.61636316246, 0.10478762755164217, 7182.209673170789, 8884.491460063697, 40_811.633125, 5.682322708769174],
          [64, 213, 307, 53_186.555323147804, 4026.538910040475, 57_213.09423318829, 0.12304721400692871, 8535.883922746882, 10_830.61816083951, 48_742.3488, 5.710287211159089],
          [128, 427, 615, 85_201.53193961504, 29_224.65652676189, 114_426.18846637658, 0.1971139335983544, 14_787.612399356698, 21_661.23632167902, 88_555.3152, 5.9884796009295185]
        ]
      )
    end
  end
end
